<!DOCTYPE html>
<html lang="en">

<head>
    <text>Treelo:</text>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <text>Collapsible Tree Example</text>

    <style>
        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: #f1f1f1;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        #main {
            transition: margin-left .5s;
            padding: 16px;
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }

            .sidenav a {
                font-size: 18px;
            }
        }
    </style>

</head>
<div id="main">
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; Treelo Menu</span>
</div>
<div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
</div>
<button type="button" id="add-node-mode" onClick="setAddMode()">Add Node</button>
<button type="button" id="remove-node" onClick="setDeleteMode()">Delete Card?</button>

<body>
    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <form class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <p conteditable="true" id="modal-title"> test </p>
                </div>
                <p id="node-data"> test2
                </p>
                <div class="modal-footer">
                    <button type="button" id="submit-changes">Save Changes</button>                </div>
            </form>

        </div>
    </div>

    </div>


    <form>
        Enter New Root Node Information:
        <div>
            <label for="titleText">Card Title</label>
            <input id="titleText" type="text" name="titleText">
        </div>
        <div>
            <label for="description">Card Description</label>
            <input id="description" type="textarea" rows="4" cols="10" name="description">
        </div>
        <div>
            <br><input id="submit" type="button" value="submit" onclick="makeNewData()" />

        </div>
    </form>


    <!-- load the d3.js library -->
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script>

        //NEW TREE
        function makeNewData() {
            var Title =
                document.getElementById("titleText").value;
            var Description =
                document.getElementById("description").value;
            if (Title != "" && Description != "") {
                var data = [{
                    "title": Title,
                    "parent": null,
                    "description": Description,
                    "children": [],
                    "_id": Math.random() + ""
                }]
                treeData.push(data[0])
                displayTree(data[0])
                document.getElementById("mySidenav").innerHTML += "<br><button id = " + '"' + data[0]._id + '"' + "onClick = findTree()>" + data[0].title + "</button>";

            }
        }

        var globalTreeArray;
        var nodeView = 'Collapse';

        var treeData = [
            {
                "sharedUsers": [
                    "janedoe@gmail.com",
                    "benbaierl@case.edu"
                ],
                "children": [
                    {
                        "title": "Child1",
                        "description": "child 1 description",
                        "dueDate": "",
                        "owner": "johndoe@gmail.com",
                        "sharedUsers": [
                            "janedoe@gmail.com",
                            "benbaierl@case.edu"
                        ],
                        "isComplete": false,
                        "isOverdue": false,
                        "children": []
                    }
                ],
                "_id": "5daf8c0d73afd05a10c15331",
                "dueDate": null,
                "title": "Test title 1",
                "description": "test description",
                "owner": "johndoe@gmail.com",
                "isComplete": false,
                "isOverdue": false,
                "__v": 0
            },
            {
                "sharedUsers": [
                    "janedoe@gmail.com",
                    "benbaierl@case.edu"
                ],
                "children": [
                    {
                        "title": "Child1",
                        "description": "child 2 description",
                        "dueDate": "",
                        "owner": "johndoe@gmail.com",
                        "sharedUsers": [
                            "janedoe@gmail.com",
                            "benbaierl@case.edu"
                        ],
                        "isComplete": false,
                        "isOverdue": false,
                        "children": [{
                            "sharedUsers": [
                                "janedoe@gmail.com",
                                "benbaierl@case.edu"
                            ],
                            "children": [
                                {
                                    "title": "Child1",
                                    "description": "child 2 description",
                                    "dueDate": "",
                                    "owner": "johndoe@gmail.com",
                                    "sharedUsers": [
                                        "janedoe@gmail.com",
                                        "benbaierl@case.edu"
                                    ],
                                    "isComplete": false,
                                    "isOverdue": false,
                                    "children": []
                                },
                                {
                                    "sharedUsers": [
                                        "janedoe@gmail.com",
                                        "benbaierl@case.edu"
                                    ],
                                    "children": [
                                        {
                                            "title": "Child1",
                                            "description": "child 2 description",
                                            "dueDate": "",
                                            "owner": "johndoe@gmail.com",
                                            "sharedUsers": [
                                                "janedoe@gmail.com",
                                                "benbaierl@case.edu"
                                            ],
                                            "isComplete": false,
                                            "isOverdue": false,
                                            "children": []
                                        }
                                    ],
                                    "_id": "5daf8c0d73afd051",
                                    "dueDate": null,
                                    "title": "Test title 2",
                                    "description": "test description",
                                    "owner": "johndoe@gmail.com",
                                    "isComplete": false,
                                    "isOverdue": false,
                                    "__v": 0
                                }
                            ],
                            "_id": "5daf8c0d73afd051",
                            "dueDate": null,
                            "title": "Test title 2",
                            "description": "test description",
                            "owner": "johndoe@gmail.com",
                            "isComplete": false,
                            "isOverdue": false,
                            "__v": 0
                        }]
                    }
                ],
                "_id": "5daf8c0d73afd051",
                "dueDate": null,
                "title": "Test title 2",
                "description": "test description",
                "owner": "johndoe@gmail.com",
                "isComplete": false,
                "isOverdue": false,
                "__v": 0
            },
            {
                "sharedUsers": [
                    "janedoe@gmail.com",
                    "benbaierl@case.edu"
                ],
                "children": [
                    {
                        "title": "Child1",
                        "description": "child 1 description",
                        "dueDate": "",
                        "owner": "johndoe@gmail.com",
                        "sharedUsers": [
                            "janedoe@gmail.com",
                            "benbaierl@case.edu"
                        ],
                        "isComplete": false,
                        "isOverdue": false,
                        "children": [{
                            "title": "Child1",
                            "description": "child 1 description",
                            "dueDate": "",
                            "owner": "johndoe@gmail.com",
                            "sharedUsers": [
                                "janedoe@gmail.com",
                                "benbaierl@case.edu"
                            ],
                            "isComplete": false,
                            "isOverdue": false,
                            "children": []
                        }]
                    }
                ],
                "_id": "5daf8c0d73afd05a10c15331asdfsadf",
                "dueDate": null,
                "title": "Test title 3",
                "description": "test description",
                "owner": "johndoe@gmail.com",
                "isComplete": false,
                "isOverdue": false,
                "__v": 0
            }
        ];

        var foundTreeForRender;

        function findTree(d) {
            treeData.forEach(findMatchingID)
            displayTree(foundTreeForRender);
        }

        function findMatchingID(item, index) {
            if (item._id == event.target.id) {
                foundTreeForRender = item;
            }
        }

        treeData.forEach(myFunction);

        function myFunction(item, index) {
            document.getElementById("mySidenav").innerHTML += "<br><button id = " + '"' + item._id + '"' + "onClick = findTree()>" + item.title + "</button>";
        }

        var currentNode;

        // ************** Generate the tree diagram  *****************
        var margin = { top: 20, right: 120, bottom: 20, left: 120 },
            width = 1000 - margin.right - margin.left,
            height = 1000 - margin.top - margin.bottom;

        var i = 0;

        var duration = 750;

        var tree = d3.layout.tree()
            .size([height, width]);

        var diagonal = d3.svg.diagonal()
            .projection(function (d) { return [d.x, d.y]; });

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.right + margin.left)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        root = treeData[0];
        root.x0 = height / 2;
        root.y0 = 0;

        update(root);

        d3.select(self.frameElement).style("height", "500px");

        function update(source) {

            // Compute the new tree layout.
            var nodes = tree.nodes(root).reverse(),
                links = tree.links(nodes);

            // Normalize for fixed-depth.
            nodes.forEach(function (d) { d.y = d.depth * 100; });

            // Declare the nodesâ€¦
            var node = svg.selectAll("g.node")
                .data(nodes, function (d) { return d.id || (d.id = ++i); });

            // Enter the nodes.
            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + d.y + "," + d.x + ")";
                })
                .on("click", dblclick)
                .on("dblclick", click);


            nodeEnter.append("circle")
                .attr("r", 10)
                .style("fill", function (d) { return d._children ? "lightsteelblue" : "#fff"; });
            nodeEnter.append("text")
                .attr("x", function (d) {
                    return d.children || d._children ? -13 : 13;
                })
                .attr("dy", ".35em")
                .attr("text-anchor", function (d) {
                    return d.children || d._children ? "end" : "start";
                })
                .text(function (d) { return d.title; })
                .style("fill-opacity", 1);

            // Transition nodes to their new position.
            var nodeUpdate = node.transition()
                .duration(duration)
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

            nodeUpdate.select("circle")
                .attr("r", 10)
                .style("fill", function (d) { return d._children ? "lightsteelblue" : "#fff"; });

            nodeUpdate.select("text")
                .style("fill-opacity", 1);

            // Transition exiting nodes to the parent's new position.
            var nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", function (d) { return "translate(" + source.x + "," + source.y + ")"; })
                .remove();

            nodeExit.select("circle")
                .attr("r", 1e-6);

            nodeExit.select("text")
                .style("fill-opacity", 1e-6);


            // Declare the linksâ€¦
            var link = svg.selectAll("path.link")
                .data(links, function (d) { return d.target.id; });

            // Enter the links.
            link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", function (d) {
                    var o = { x: source.x0, y: source.y0 };
                    return diagonal({ source: o, target: o });
                })

            // Transition links to their new position.
            link.transition()
                .duration(duration)
                .attr("d", diagonal);

            // Transition exiting nodes to the parent's new position.
            link.exit().transition()
                .duration(duration)
                .attr("d", function (d) {
                    var o = { x: source.x, y: source.y };
                    return diagonal({ source: o, target: o });
                })
                .remove();

            // Stash the old positions for transition.
            nodes.forEach(function (d) {
                d.x0 = d.x;
                d.y0 = d.y;
            });


        }

        function click(d) {
            //alert(d.name);
            //var item = findDescription(treeData, d.name);
            document.getElementById("node-data").innerHTML = "  Description:<br/>   " + d.description;
            document.getElementById("modal-title").innerHTML = d.title;
            currentNode = d;
            $('#myModal').modal("toggle");
        }

        // Toggle children on click.
        function dblclick(d) {
            if (nodeView === 'Collapse') {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;
                }
                update(d);
            }
            else if(nodeView === 'Add'){
                var newChild = {
                    "title": "New Node",
                    "description": "Enter Description Here",
                    "parent": d.title,
                    "children": [],
                    "_id": Math.random() + ""
                }
                if(d.children == null){
                    newchildren = [];
                    d.children = newchildren;
                }
                d.children.push(newChild)
                nodeView = 'Collapse';
                update(d);
            }
            else if(nodeView === 'Delete'){
               // alert('made it here')
                currentNode = d;
                removeNode();
                nodeView = 'Collapse';
            }
        }

        function removeNode(d) {
            if(currentNode.parent == null){
                deleteTree()
                alert(currentNode.parent.title)
                $("#" + currentNode._id).hide();
                //update info for removing Tree
            }
           // alert('Deleted ' + currentNode.title)
            //alert("made it here")
            //this is the links target node which you want to remove
            var target = currentNode;
            //make new set of children
            var children = [];
            //iterate through the children 
            target.parent.children.forEach(function (child) {
                if (child.id != target.id) {
                    //add to teh child list if target id is not same 
                    //so that the node target is removed.
                    children.push(child);
                }
            });
            alert(target.parent.title)
            //set the target parent with new set of children sans the one which is removed
            target.parent.children = children;
            //redraw the parent since one of its children is removed
            update(target.parent)
        }

        //NAVIGATION BAR
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            document.body.style.backgroundColor = "white";
        }


        function deleteTree(d) {
            var treeData = [
                {
                    "title": "Make a new Treelo Tree using the buttons below or open an existing tree with the Navigation Bar!"
                }];
            root = treeData[0];
            root.x0 = height / 2;
            root.y0 = 0;
            update(root);
        }

        function displayTree(data) {
            root = data;
            root.x0 = height / 2;
            root.y0 = 0;

            update(root);

            d3.select(self.frameElement).style("height", "500px");
        }

        function showDivText(ID) {
            divObj = document.getElementById(ID);
            if (divObj) {
                if (divObj.textContent) {
                    return divObj.textContent;
                } else {
                    return divObj.innerText;  //alert ( divObj.innerHTML );
                }
            }
        }

        function findAndRemove(array, property, value) {
            array.forEach(function (result, index) {
                if (result[property] === value) {
                    array.splice(index, 1);
                }
            });
        }

        function updateNodeInfo(d) {
            alert('here I am')
            var Title =
                document.getElementById("modal-title").value;
            var Description =
                document.getElementById("modal-data").value;
        }
        
        function setDeleteMode(){
            nodeView = 'Delete';
            alert("You have netered delete node mode. Click a node to delete it and its children\n**Warning Deletion is perminant**")
        }

        function setAddMode(d){
            nodeView = 'Add';
            alert("You have entered add node mode. Click a node to add a child")
        }


        //document.querySelector('#remove-node').addEventListener('click', removeNode);
        document.querySelector('#save-changes').addEventListener('click', updateNodeInfo);

    </script>

</body>

</html>